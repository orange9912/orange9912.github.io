<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="orange's blog" href="http://zyczxq.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="orange's blog" href="http://zyczxq.com/atom.xml"><link rel="alternate" type="application/json" title="orange's blog" href="http://zyczxq.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://zyczxq.com/2021/09/01/JavaScript/axios/"><title>Axios源码解析 - 前端 | orange's blog = orange's blog = 橙子的博客</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Axios源码解析</h1><div class="meta"><span class="item" title="创建时间：2021-09-01 14:34:36"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-09-01T14:34:36+08:00">2021-09-01</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">orange's blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://pic1.zhimg.com/v2-3860c6e6300302777076cafe739d22c6_r.jpg?source=1940ef5c"></li><li class="item" data-background-image="https://pic1.zhimg.com/v2-8be6dffda384a15658d77850a5126664_r.jpg"></li><li class="item" data-background-image="https://img0.baidu.com/it/u=1512883555,827303141&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500"></li><li class="item" data-background-image="https://img.likebizhi.com/uploads/likebizhi/up/2022/07/36f712de0483dd1d87444a3b1a9b76c5518.jpg"></li><li class="item" data-background-image="https://pic3.zhimg.com/v2-30e2ad47c97fe080a3fa478a2ebcd07a_r.jpg"></li><li class="item" data-background-image="https://imgs.aixifan.com/content/2019_10_18/1.5713970969678602E9.jpeg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/JavaScript/" itemprop="item" rel="index" title="分类于 前端"><span itemprop="name">前端</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://zyczxq.com/2021/09/01/JavaScript/axios/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar1.jpg"><meta itemprop="name" content="orange"><meta itemprop="description" content="橙子的博客, 博客"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="orange's blog"></span><div class="body md" itemprop="articleBody"><p>前几天面试，和面试官聊天时</p><p>面试官：“你有没有想过看一下源码，而不是看那些分析文章，可能直接看源码收益来的直接一点”</p><p>我：“以前尝试过看的框架源码，不过觉得好晦涩，看不懂，打算等水平提升一点再看”</p><p>——————————————————————————————————————————————</p><p>于是最近几天，我觉得自己的水平相比以前也有点提升，虽然看不懂框架源码，但是我应该勉强能看懂一些简单库的源码？</p><p><strong>于是就选中了 Axios</strong>，仔细查找一番资料 + 拉取 github 上的代码慢慢看，确实有了不少收获，还加深了理解。</p><p>于是就有了这篇文章，不过源码的内容实在太多，所以这篇文章只是简单对工作流程源码的一篇解析，其他的功能还请慢慢读源码</p><p>——————————————————————————————————————————————</p><p>第一次写，可能有点乱，求大佬轻喷</p><h1 id="axios是什么"><a class="anchor" href="#axios是什么">#</a> Axios 是什么</h1><p>axios 是一个基于 Promise 的 HTTP 库，可以用在浏览器和 nodejs 之中使用。</p><p>它的特点有：</p><ul><li>从浏览器创建 XMLHttpRequests</li><li>从 nodejs 创建 http 请求</li><li>支持 Promise</li><li>拦截请求和响应</li><li>取消请求</li><li>自动转换 JSON</li><li>客户端支持防御 CSRF</li></ul><h1 id="axios使用方式"><a class="anchor" href="#axios使用方式">#</a> Axios 使用方式</h1><p>了解它的内部机制之前，我们先要知道该模块的功能、输入输出，才能更好的了解它。</p><h2 id="方法1直接使用axios构造函数"><a class="anchor" href="#方法1直接使用axios构造函数">#</a> 方法 1: 直接使用 axios 构造函数</h2><p>axios(config) || axios(url[,config])</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">'/user/12345'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token literal-property property">firstName</span><span class="token operator">:</span><span class="token string">'Orange'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token literal-property property">lastName</span><span class="token operator">:</span><span class="token string">'juice'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="方法2使用axios对象的方法"><a class="anchor" href="#方法2使用axios对象的方法">#</a> 方法 2: 使用 axios 对象的方法</h2><ul><li>axios.request(config)</li><li>axios.get(url[,config])</li><li>axios.post(url[,data[,config]])</li><li>等等如 head、delete、put 方法</li></ul><h2 id="方法3axioscreate"><a class="anchor" href="#方法3axioscreate">#</a> 方法 3:axios.create...</h2><h1 id="从axios入口文件分析axios工作流程"><a class="anchor" href="#从axios入口文件分析axios工作流程">#</a> 从 axios 入口文件分析 Axios 工作流程</h1><p>暴露在项目根目录下的：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//index.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 就这么一行代码，让我们把目光放在 axios.js</span></pre></td></tr><tr><td data-num="3"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>然后跑去找到 axios.js</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//axios.js 的局部核心代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * 创建 axios</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param &#123;Object&#125; defaultConfig The default config for the instance</pre></td></tr><tr><td data-num="6"></td><td><pre> * @return &#123;Axios&#125; A new instance of Axios</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">function</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token parameter">defaultConfig</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 创建 Axios 实例，参数为默认配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Axios</span><span class="token punctuation">(</span>defaultConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 将 Axios.prototype.request 的函数的 this 绑定指向到 context（创建的 axios 实例)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 类似于 Axios.prototype.request.bind (context)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>request<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 将 Axios.prototype 上的方法和属性都扩展到 instance 上，并且将这些扩展的方法绑定 this 为 context</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  utils<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 把 context 上的方法和属性扩展到新的 Axios 实例上，主要是配置和拦截器</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  utils<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">return</span> instance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// 创建一个 axios 实例导出，这个实例实际上指向的是 Axios.prototype.request 函数</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">var</span> axios <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// 新建 Axios 实例的工厂方法</span></pre></td></tr><tr><td data-num="24"></td><td><pre>axios<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// 创建一个 axios 实例，配置为原先 defaults.js 中的配置 + 参数传入的配置</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">// 配置会以一个优先顺序进行合并，优先级为 lib/default.js 的默认值 & lt; 实例的 defaults&lt; 请求的 config</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token function">mergeConfig</span><span class="token punctuation">(</span>axios<span class="token punctuation">.</span>defaults<span class="token punctuation">,</span> instanceConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">// 导出 axios</span></pre></td></tr><tr><td data-num="30"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> axios<span class="token punctuation">;</span></pre></td></tr></table></figure><p>在这里我们可以看到，初始化的时候已经新建了一个默认配置的实例，<strong>这个实例指向 Axios.prototype.request 函数 (绑定了一个 Axios 实例)</strong>，当我们以 axios () 方式调用的时候，实际上是执行了 createInstance 返回的一个指向 Axios.prototype.request 的函数。</p><p>当然，也支持使用 axios.create 来新建一个自定义配置的实例（也是指向 request 函数），<strong>但最终也是执行 Axios.prototype.request 方法</strong>。</p><p><strong>从这里我们可以看出，axios 指向发请求的函数，而 Axios 是保存实例默认配置的对象，当调用 axios 的时候，使用对应的 Axios 实例的默认配置 + 参数配置来发起请求</strong></p><div class="note primary"><p>当我们没有特别的要求时，使用默认的 axios 实例即可，否则的话我们可以新建一个 axios 实例（传入定制的配置信息），并且通过调用这个新建的实例来发起请求。</p></div><p>既然发送请求最终调用的都是 Axios.prototype.request 函数，那我们来<span class="pink">简单</span>看看 Axios.js 文件内部的代码，涉及某功能模块的具体解析在后面再详细讲，这里只是为了分析 Axios 的工作流程。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//Axios.js 部分代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//Axios 构造函数，一个 Axios 实例里有实例配置和请求拦截器 + 响应拦截器</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">function</span> <span class="token function">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>defaults <span class="token operator">=</span> instanceConfig<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token literal-property property">response</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">request</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 如果第一个参数是字符串，则是 url，否则是配置对象，axios (url [,config]) || axios (config)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> config <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    config <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    config<span class="token punctuation">.</span>url <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    config <span class="token operator">=</span> config <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 合并 Axios 实例中保存的默认配置和参数配置，默认配置优先级更低</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">// 若传入配置中指定了方法（或者实例 defaults 配置指定了），则改为小写，否则默认为 get 方法</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    config<span class="token punctuation">.</span>method <span class="token operator">=</span> config<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    config<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    config<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'get'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">// 过滤跳过的拦截器</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">var</span> requestInterceptorChain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">var</span> synchronousRequestInterceptors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 是否同步执行</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// 此方法对请求拦截器中每一项中执行函数 unshiftRequestInterceptors（会自动排除被 eject 注销的 handler）</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 把拦截器中每一项存入 requestInterceptorChain</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">unshiftRequestInterceptors</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> interceptor<span class="token punctuation">.</span>runWhen <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> interceptor<span class="token punctuation">.</span><span class="token function">runWhen</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 只要有一个异步执行，整个队列都异步执行</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    synchronousRequestInterceptors <span class="token operator">=</span> synchronousRequestInterceptors <span class="token operator">&amp;&amp;</span> interceptor<span class="token punctuation">.</span>synchronous<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	  <span class="token comment">// 注意这里是 unshift，所以先定义的拦截器是后执行的（栈）</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    requestInterceptorChain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">// 基本同上，但这里是 push，正序</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">var</span> responseInterceptorChain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">pushResponseInterceptors</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    responseInterceptorChain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">var</span> promise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// 若需要异步执行，则异步执行拦截器数组</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>synchronousRequestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">var</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>dispatchRequest<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 将派发请求放在请求拦截器数组异步执行完的最后一步执行</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> requestInterceptorChain<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    chain<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>responseInterceptorChain<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    </pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">return</span> promise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">// 否则同步执行请求拦截器，直到拦截器栈清空</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token keyword">var</span> newConfig <span class="token operator">=</span> config<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>requestInterceptorChain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">var</span> onFulfilled <span class="token operator">=</span> requestInterceptorChain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">var</span> onRejected <span class="token operator">=</span> requestInterceptorChain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      newConfig <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token function">onRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// 请求拦截器执行完之后，派发请求</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    promise <span class="token operator">=</span> <span class="token function">dispatchRequest</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token comment">// 执行响应拦截器，异步执行</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>responseInterceptorChain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>responseInterceptorChain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> responseInterceptorChain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token comment">// 最后返回一个 promise 对象</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token keyword">return</span> promise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h1 id="axios工作流程"><a class="anchor" href="#axios工作流程">#</a> Axios 工作流程</h1><p>根据上面源代码的分析，我们可以知道 Axios 的工作流程大概是这些</p><ol><li><p>创建 Axios 实例（createInstance），自定义创建配置或使用默认配置</p></li><li><p>调用 axios，传入配置，合并配置并做一些处理</p></li><li><p>执行请求拦截器（requestInterceptorManager）。</p><p>拦截器的 handler 会收到实例的配置作为参数，然后需要返回一份新的配置</p></li><li><p>派发请求（dispatchRequest）</p></li><li><p>转换请求数据（transformData）</p></li><li><p>使用 Adapter 处理请求（xhr.js 或 http.js）</p></li><li><p>转换响应数据（transformData）</p></li><li><p>执行响应拦截器（responseInterceptorManager）</p></li><li><p>结束，返回一个 promise</p></li></ol><h1 id="拦截器模块"><a class="anchor" href="#拦截器模块">#</a> 拦截器模块</h1><p>在 Axios 实例的代码中，每个 Axios 实例都有着请求拦截器和响应拦截器。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//Axios.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>defaults <span class="token operator">=</span> instanceConfig<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token literal-property property">response</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>让我们看看拦截器中的代码具体是怎么写的，</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//InterceptorManager.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 往栈里增加一个新的拦截器</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fulfilled<span class="token punctuation">,</span> rejected<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token literal-property property">fulfilled</span><span class="token operator">:</span> fulfilled<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token literal-property property">rejected</span><span class="token operator">:</span> rejected<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 决定该拦截器是否同步执行</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token literal-property property">synchronous</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>synchronous <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token literal-property property">runWhen</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>runWhen <span class="token operator">:</span> <span class="token keyword">null</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 返回一个下标，方便之后注销该 handler</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">eject</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 其实就是用这个下标去注销 handler，在下面的 forEach 方法中会跳过被注销的</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// 对拦截器数组中的每一项执行 fn</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">forEach</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">//utils.forEach 实际上是对第一个参数进行遍历，执行第二个参数函数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  utils<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">forEachHandler</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">//h 是传入的每一项，忽略被注销的</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token function">fn</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>我们可以看到，一个 InterceptorManager 对象保存着一个 handlers 数组，用来保存一个对象（这个对象包含了不同情况下执行的拦截函数）。结合 Axios.js，有几个信息：</p><ul><li><p>使用 use 方法添加一个拦截器，use 方法返回一个下标。</p></li><li><p>可以使用 use 方法返回的下标来调用 eject 注销拦截器</p></li><li><p>在 Axios.prototype.request 方法中，调用实例的 forEach 方法来复制一份拦截器队列执行</p></li><li><p>请求拦截器先定义的后执行，响应拦截器先定义的先执行</p></li><li><p>请求拦截器可同步或异步执行，响应拦截器异步执行</p><p>请求拦截器的执行可以要求异步执行，也可以是同步执行，如果要异步执行，设置拦截器的时候给第三个参数传入一个 options 对象，设置 options.synchronous = false 即可（<strong>只要有一个需要异步执行，那整个队列都异步执行</strong>）</p></li></ul><h1 id="派发请求模块"><a class="anchor" href="#派发请求模块">#</a> 派发请求模块</h1><p>源码：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//lib/core/dispatchRequest.js 部分核心代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// 保证 headers 存在</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  config<span class="token punctuation">.</span>headers <span class="token operator">=</span> config<span class="token punctuation">.</span>headers <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 转换请求数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  config<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    config<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    config<span class="token punctuation">.</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    config<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    config<span class="token punctuation">.</span>transformRequest</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// Flatten headers</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  config<span class="token punctuation">.</span>headers <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>config<span class="token punctuation">.</span>method<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    config<span class="token punctuation">.</span>headers</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">// 可以自定义适配器，否则就用默认的（浏览器下用 xhr.js）</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">var</span> adapter <span class="token operator">=</span> config<span class="token punctuation">.</span>adapter <span class="token operator">||</span> defaults<span class="token punctuation">.</span>adapter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">adapter</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onAdapterResolution</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">throwIfCancellationRequested</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  </pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 转换响应数据</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    response<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      config<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      response<span class="token punctuation">.</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      response<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      config<span class="token punctuation">.</span>transformResponse</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> response<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onAdapterRejection</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCancel</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token function">throwIfCancellationRequested</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token comment">// 转换响应数据</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">&amp;&amp;</span> reason<span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        reason<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          config<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          reason<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          reason<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          config<span class="token punctuation">.</span>transformResponse</pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		</pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可以看到，派发请求模块主要是以下几个流程：</p><ol><li>转换请求数据、设置头部、选择适配器</li><li>发送请求</li><li>得到响应后进行对应的处理，如成功后转换数据并返回</li></ol><h1 id="转换数据模块"><a class="anchor" href="#转换数据模块">#</a> 转换数据模块</h1><p>在 dispatchRequest.js 中，我们可以看到对请求数据的转换和对响应数据的转换代码，如下</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//lib/core/dispatchRequest.js 转换数据局部代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 对请求数据的转换</span></pre></td></tr><tr><td data-num="3"></td><td><pre>config<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  config<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  config<span class="token punctuation">.</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  config<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  config<span class="token punctuation">.</span>transformRequest</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">...</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 对响应数据的转换</span></pre></td></tr><tr><td data-num="11"></td><td><pre>response<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  config<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  response<span class="token punctuation">.</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  response<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  config<span class="token punctuation">.</span>transformResponse</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在这里我们可以看到，有两个关键点：<strong>transformData 和 config.transformResponse</strong></p><h2 id="transformdata"><a class="anchor" href="#transformdata">#</a> transformData</h2><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// lib/core/transformData.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 转换请求 / 响应数据</span></pre></td></tr><tr><td data-num="3"></td><td><pre>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">transformData</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> fns</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token operator">||</span> defaults<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 注意这里的 fns，是转换函数数组，为扩展转换埋下了伏笔</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  utils<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fns<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    data <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> data<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>结合在派发请求时候的调用，我们可以知道以下几点</p><ul><li>这个函数本身并不直接转换数据，而是调用 defaults.js 中的转换方法数组来进行一个转换</li><li>传入要转换的 data 和 headers，然后返回一份转换好的 data</li><li>转换函数可以扩展个数和重写</li></ul><h2 id="configtransformresponserequest"><a class="anchor" href="#configtransformresponserequest">#</a> config.transformResponse/Request</h2><p>通过上面可以知道，真正转换数据的是 axios.default.transformRequest (Response) 方法</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// defaults.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token literal-property property">transformRequest</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> headers</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">normalizeHeaderName</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'Accept'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">normalizeHeaderName</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 如果是特殊的数据，不需要进行转换直接返回</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isFormData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      utils<span class="token punctuation">.</span><span class="token function">isArrayBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      utils<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      utils<span class="token punctuation">.</span><span class="token function">isStream</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      utils<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      utils<span class="token punctuation">.</span><span class="token function">isBlob</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isArrayBufferView</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">return</span> data<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isURLSearchParams</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token function">setContentTypeIfUnset</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 如果是对象且我们规定了 json, 则进行 json.stringift 转化</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>headers <span class="token operator">&amp;&amp;</span> headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">setContentTypeIfUnset</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr></table></figure><p>这个模块并不是很复杂，基本就是按照 headers 的类型和数据本身类型做的一个转换处理，为了减少篇幅就不贴 transformResponse 部分的代码了，可以自行下载源码查看</p><h2 id="扩展"><a class="anchor" href="#扩展">#</a> 扩展</h2><p>我们可以看到，在我们没有刻意去重写转换方法的时候，它使用的是 defaults.js 中默认的转换方法，但其实我们也可以根据需要，去增加或者重写转换方法。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 这里导入的是默认的 axios 实例，我们也可以 axios.create 创建一个自定义配置实例</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">let</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  baseURL<span class="token operator">=</span><span class="token string">'https://xxx.com'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>instance<span class="token punctuation">.</span>default<span class="token punctuation">.</span>transformRequest<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>headers</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 进行一系列的处理</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 或者进行重写</span></pre></td></tr><tr><td data-num="11"></td><td><pre>instance<span class="token punctuation">.</span>default<span class="token punctuation">.</span>transformRequest <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>headers</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">// 同上</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr></table></figure><h2 id="转换模块总结"><a class="anchor" href="#转换模块总结">#</a> 转换模块总结</h2><p>总的来说</p><ol><li><p>派发请求的时候，将请求模块 config 作为<strong> transformData 的 this 指向，调用 transformData</strong></p></li><li><p>transformData 中会根据传入的 config.transformRequest 方法，来进行一个转换</p><p>如果自定义的 axios 实例有进行重写或扩展，就调用我们重写或扩展的，否则就用默认的 default.js 中的</p></li><li><p>转换完成，返回转换完成的数据</p></li></ol><h1 id="axios对ajax封装的模块"><a class="anchor" href="#axios对ajax封装的模块">#</a> Axios 对 ajax 封装的模块</h1><p>接下来到了最核心的地方：<strong>Axios 是如何对将 ajax 请求 promise 化的？</strong></p><p>话不多说，我们来看源代码（浏览器环境下的封装）</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//xhr.js 部分核心代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">xhrAdapter</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">dispatchXhrRequest</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 分离出请求相关的配置、数据、头部</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">var</span> requestData <span class="token operator">=</span> config<span class="token punctuation">.</span>data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> requestHeaders <span class="token operator">=</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> responseType <span class="token operator">=</span> config<span class="token punctuation">.</span>responseType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 新建一个 XMLHttpRequest 对象</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 路径为 baseURL+configURL</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">var</span> fullPath <span class="token operator">=</span> <span class="token function">buildFullPath</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>baseURL<span class="token punctuation">,</span> config<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//ajax 请求方法、url 设置</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>params<span class="token punctuation">,</span> config<span class="token punctuation">.</span>paramsSerializer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 设置超时时间</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    request<span class="token punctuation">.</span>timeout <span class="token operator">=</span> config<span class="token punctuation">.</span>timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 请求结束的处理函数</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">onloadend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token comment">// 处理响应数据，略</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token operator">...</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment">// 根据响应状态码设置 Promise 是 resolve 还是 reject</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token function">settle</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// 加载完后置 null</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">//onloadend 是一个属性，请求结束时就会存在</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 不存在就监听状态变化</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'onloadend'</span> <span class="token keyword">in</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      request<span class="token punctuation">.</span>onloadend <span class="token operator">=</span> onloadend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token comment">//readyState 为 4 的时候代表已完成</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      request<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request <span class="token operator">||</span> request<span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        </pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 宏任务，当同步任务执行完毕后执行</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token function">setTimeout</span><span class="token punctuation">(</span>onloadend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 当请求被丢弃或者手动停止时的处理</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    request<span class="token punctuation">.</span>onabort <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 网络出错处理</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 超时处理函数</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    request<span class="token punctuation">.</span>ontimeout <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 在标准浏览器环境里添加 CSRF 头部，来防御 CSRF 攻击</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isStandardBrowserEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">// 如果该请求携带 cookie 或者是同源网站就需要添加 (用于鉴权)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">var</span> xsrfValue <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>withCredentials <span class="token operator">||</span> <span class="token function">isURLSameOrigin</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>xsrfCookieName <span class="token operator">?</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        cookies<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>xsrfCookieName<span class="token punctuation">)</span> <span class="token operator">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">undefined</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>xsrfValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        requestHeaders<span class="token punctuation">[</span>config<span class="token punctuation">.</span>xsrfHeaderName<span class="token punctuation">]</span> <span class="token operator">=</span> xsrfValue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">// 添加配置到请求头，略</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requestData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      requestData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 发送请求</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>requestData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>总的来说其实就是将 ajax 请求 promise 化，封装进去，先进行一波配置的处理，然后请求结束时再根据状态码决定该 Promise 是完成还是失败状态。</p><p>在这里还加了对 csrf 攻击的防御。</p><h1 id="取消请求模块"><a class="anchor" href="#取消请求模块">#</a> 取消请求模块</h1><h2 id="使用方式"><a class="anchor" href="#使用方式">#</a> 使用方式</h2><p>在文档上我们查看到取消请求的两种方式</p><ul><li><p>使用 CancelToken.source 工厂方法产生 cancel token</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> CancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> source <span class="token operator">=</span> CancelToken<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/12345'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token literal-property property">cancelToken</span><span class="token operator">:</span> source<span class="token punctuation">.</span>token</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">thrown</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>axios<span class="token punctuation">.</span><span class="token function">isCancel</span><span class="token punctuation">(</span>thrown<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Request canceled'</span><span class="token punctuation">,</span> thrown<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 处理错误</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 取消请求（message 参数是可选的）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>source<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">'Operation canceled by the user.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>或者传递一个 executor 函数到 CancelToken 的构造函数来创建 cancel token</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> CancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> cancel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/12345'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token literal-property property">cancelToken</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//executor 函数接收一个 cancel 函数作为参数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    cancel <span class="token operator">=</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 取消请求</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><p>从上述使用方式我们可以看到，要对请求产生一个 cancelToken，然后在配置项中将请求的 cancelToken 设置为我们产生的 cancelToken。</p><p>这个 cancelToken 具有一个 cancel 方法，通过调用它可以取消请求。</p><h2 id="原理"><a class="anchor" href="#原理">#</a> 原理</h2><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// dispatchRequest.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * 如果被要求取消，就抛出 cancel, 这个方法在派发请求前和响应后都会调用一次</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">function</span> <span class="token function">throwIfCancellationRequested</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 下面一行干了这个事：if (token.reason) throw token.reason;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span><span class="token function">throwIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// CancelToken.js 部分核心代码</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">function</span> <span class="token function">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token operator">...</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">var</span> resolvePromise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">promiseExecutor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    resolvePromise <span class="token operator">=</span> resolve<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">// 这里的 cancel 函数实际上就是取消请求函数，利用 executor 向外传 cancel 回调</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// Cancellation has already been requested</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    token<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">// 用于检查是否需要取消并抛出</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token class-name">CancelToken</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">throwIfRequested</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">throwIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">// 产生 CancelToken 的工厂方法</span></pre></td></tr><tr><td data-num="41"></td><td><pre>CancelToken<span class="token punctuation">.</span><span class="token function-variable function">source</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">var</span> cancel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    cancel <span class="token operator">=</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token literal-property property">token</span><span class="token operator">:</span> token<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token literal-property property">cancel</span><span class="token operator">:</span> cancel</pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>实际上构造 cancelToken 时，利用传进来的函数将构造函数中写好的取消请求函数的引用传递出去，我们在使用的时候就可以调用该传出来的函数进行取消（这个函数会设置 token.reason 为取消的信息）。</p><p>当我们调用 cancel 方法时，会将 cancel 的信息传递，并设置 token.reason。</p><p>在进入 dispatchRequest 步骤时，如果存在 cancelToken 且 token.reason 存在，就会抛出</p><p>Xhr.js 中发送请求前，如果配置项存在 cancelToken，<strong>就会给这个 cancelToken.promise.then () 设置一个回调来取消请求</strong>。当我们调用了 cancel 方法时，token 内部的一个 promise 就会从 pending-&gt;fulfilled 状态，然后通过该回调取消请求。</p><p>如果发送完请求得到响应后，在转换数据前，Axios 也会检测，如果存在 cancelToken 且 token.reason 存在，也会抛出。</p><h2 id="设计步骤"><a class="anchor" href="#设计步骤">#</a> 设计步骤</h2><p><strong>运行步骤大概如下</strong>：</p><ol><li><p>利用构造函数或工厂方法产生一个 cancelToken，并且把它设置为对应请求的 cancelToken。</p></li><li><p>如果是利用构造函数产生，我们还需要保存一下 executor 中传递出来的 cancel 函数。</p></li><li><p>在适当的时候取消请求，调用 cancel 函数（可以传一个字符串作为信息）</p><p>此时 cancel 函数会新建一个 Cancel 实例赋给 token.reason，并且将 token 内部的 promise 完成（fulfilled）</p></li><li><p><strong>派发请求前和响应后</strong>由 dispatchRequest.js 中的方法<strong> throwIfCancellationRequested</strong> 来处理取消（如果 token.reason 存在，则表示需要取消）</p><p>若是已经在请求中，xhr.js 中有代码监听 token 内部的 promise，一旦该 promise 完成，就触发 request.abort () 来取消</p></li><li><p>取消成功</p></li></ol><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// xhr.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 请求中取消请求的代码</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// Handle cancellation</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onCanceled</span><span class="token punctuation">(</span><span class="token parameter">cancel</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">reject</span><span class="token punctuation">(</span>cancel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// Clean up request</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><p>大概花了几天的时间把 axios 中主要模块的源代码分析了一遍，确实是收益良多。</p><p>作者水平有限（只是个刚学两年的小前端），如果有不正确的地方，还请大佬轻喷。</p><p>参考：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2F4aW9zL2F4aW9z">axios/axios: Promise based HTTP client for the browser and node.js (github.com)</span></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-06-15 18:50:31" itemprop="dateModified" datetime="2024-06-15T18:50:31+08:00">2024-06-15</time> </span><span id="2021/09/01/JavaScript/axios/" class="item leancloud_visitors" data-flag-title="Axios源码解析" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="orange 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="orange 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="orange 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>orange <i class="ic i-at"><em>@</em></i>orange's blog</li><li class="link"><strong>本文链接：</strong> <a href="http://zyczxq.com/2021/09/01/JavaScript/axios/" title="Axios源码解析">http://zyczxq.com/2021/09/01/JavaScript/axios/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/08/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/HeadSort/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;b0.bdstatic.com&#x2F;c61fbd7d1ba16ab9a128b5b799fd7bda.jpg@h_1280" title="堆排序学习笔记"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 计算机基础</span><h3>堆排序学习笔记</h3></a></div><div class="item right"><a href="/2021/09/07/medical/psychiatry/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic1.zhimg.com&#x2F;v2-3860c6e6300302777076cafe739d22c6_r.jpg?source&#x3D;1940ef5c" title="精神病学"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 精神病学</span><h3>精神病学</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#axios%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.</span> <span class="toc-text">Axios 是什么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#axios%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">Axios 使用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%951%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8axios%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">方法 1: 直接使用 axios 构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%952%E4%BD%BF%E7%94%A8axios%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">方法 2: 使用 axios 对象的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%953axioscreate"><span class="toc-number">2.3.</span> <span class="toc-text">方法 3:axios.create...</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8Eaxios%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90axios%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">从 axios 入口文件分析 Axios 工作流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#axios%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">Axios 工作流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">拦截器模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B4%BE%E5%8F%91%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9D%97"><span class="toc-number">6.</span> <span class="toc-text">派发请求模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">7.</span> <span class="toc-text">转换数据模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#transformdata"><span class="toc-number">7.1.</span> <span class="toc-text">transformData</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configtransformresponserequest"><span class="toc-number">7.2.</span> <span class="toc-text">config.transformResponse&#x2F;Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-number">7.3.</span> <span class="toc-text">扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93"><span class="toc-number">7.4.</span> <span class="toc-text">转换模块总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#axios%E5%AF%B9ajax%E5%B0%81%E8%A3%85%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-number">8.</span> <span class="toc-text">Axios 对 ajax 封装的模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9D%97"><span class="toc-number">9.</span> <span class="toc-text">取消请求模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">9.1.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.3.</span> <span class="toc-text">设计步骤</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/05/23/JavaScript/JSnote1/" rel="bookmark" title="作用域及作用域链的应用">作用域及作用域链的应用</a></li><li><a href="/2021/05/24/JavaScript/JSnote2/" rel="bookmark" title="JavaScript笔记之二">JavaScript笔记之二</a></li><li><a href="/2021/05/25/JavaScript/JSnote3/" rel="bookmark" title="this关键字的笔记">this关键字的笔记</a></li><li><a href="/2021/05/26/JavaScript/flux/" rel="bookmark" title="flux">flux</a></li><li><a href="/2021/05/30/JavaScript/JSnote4/" rel="bookmark" title="一些封装的工具函数">一些封装的工具函数</a></li><li><a href="/2021/05/31/JavaScript/JSnote5/" rel="bookmark" title="JavaScript异步学习笔记">JavaScript异步学习笔记</a></li><li><a href="/2021/06/04/JavaScript/CSSnote1/" rel="bookmark" title="CSS布局知识笔记1">CSS布局知识笔记1</a></li><li><a href="/2021/06/06/JavaScript/JSnote6/" rel="bookmark" title="JavaScript运行机制笔记">JavaScript运行机制笔记</a></li><li><a href="/2021/06/11/JavaScript/http1/" rel="bookmark" title="前端计网知识总结一">前端计网知识总结一</a></li><li><a href="/2021/06/13/JavaScript/http2/" rel="bookmark" title="浏览器缓存学习笔记">浏览器缓存学习笔记</a></li><li><a href="/2021/06/14/JavaScript/storage/" rel="bookmark" title="前端存储笔记">前端存储笔记</a></li><li><a href="/2021/06/15/JavaScript/webSafe1/" rel="bookmark" title="前端安全笔记一_xss和csrf">前端安全笔记一_xss和csrf</a></li><li><a href="/2021/06/17/JavaScript/module/" rel="bookmark" title="Javascript模块化笔记">Javascript模块化笔记</a></li><li><a href="/2021/06/20/JavaScript/react1/" rel="bookmark" title="react开发笔记1">react开发笔记1</a></li><li><a href="/2021/06/21/JavaScript/crosssite/" rel="bookmark" title="跨域方法笔记">跨域方法笔记</a></li><li><a href="/2021/06/22/JavaScript/webpack1/" rel="bookmark" title="webpack学习">webpack学习</a></li><li><a href="/2021/06/24/JavaScript/CSSnote2/" rel="bookmark" title="CSS选择器优先级笔记">CSS选择器优先级笔记</a></li><li><a href="/2021/06/26/JavaScript/JSnote8/" rel="bookmark" title="尾调用/递归优化">尾调用/递归优化</a></li><li><a href="/2021/06/27/JavaScript/compare/" rel="bookmark" title="简单的比较vue、react思想">简单的比较vue、react思想</a></li><li><a href="/2021/07/01/JavaScript/reactNote2/" rel="bookmark" title="React笔记2">React笔记2</a></li><li><a href="/2021/07/20/JavaScript/Authorization/" rel="bookmark" title="单页应用鉴权问题">单页应用鉴权问题</a></li><li><a href="/2021/08/04/JavaScript/browser/" rel="bookmark" title="浏览器渲染过程">浏览器渲染过程</a></li><li class="active"><a href="/2021/09/01/JavaScript/axios/" rel="bookmark" title="Axios源码解析">Axios源码解析</a></li><li><a href="/2021/09/23/JavaScript/v8-memoryManage/" rel="bookmark" title="V8的垃圾回收机制">V8的垃圾回收机制</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="orange" data-src="/images/avatar1.jpg"><p class="name" itemprop="name">orange</p><div class="description" itemprop="description">博客</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">47</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">10</span> <span class="name">分类</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/08/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/HeadSort/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/09/07/medical/psychiatry/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/JavaScript/" title="分类于 前端">前端</a></div><span><a href="/2021/06/24/JavaScript/CSSnote2/" title="CSS选择器优先级笔记">CSS选择器优先级笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%A4%96%E7%A7%91%E5%AD%A6/" title="分类于 外科学">外科学</a></div><span><a href="/2021/09/13/medical/miniaoSystem/" title="第四十八篇 泌尿系统损伤">第四十八篇 泌尿系统损伤</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" title="分类于 计算机基础">计算机基础</a></div><span><a href="/2021/07/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/designPatterns/" title="设计模式笔记">设计模式笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vue/" title="分类于 Vue">Vue</a></div><span><a href="/2021/10/15/Vue/VueNote/" title="深入浅出Vue笔记————响应式系统篇">深入浅出Vue笔记————响应式系统篇</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaScript/" title="分类于 前端">前端</a></div><span><a href="/2021/06/11/JavaScript/http1/" title="前端计网知识总结一">前端计网知识总结一</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaScript/" title="分类于 前端">前端</a></div><span><a href="/2021/06/15/JavaScript/webSafe1/" title="前端安全笔记一_xss和csrf">前端安全笔记一_xss和csrf</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/work/" title="分类于 工作沉淀">工作沉淀</a></div><span><a href="/2024/06/15/work/webview-performance/" title="H5体验优化的实践与总结">H5体验优化的实践与总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/2021/05/31/Linux/LinuxNote1/" title="Linux实验一笔记">Linux实验一笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaScript/" title="分类于 前端">前端</a></div><span><a href="/2021/05/24/JavaScript/JSnote2/" title="JavaScript笔记之二">JavaScript笔记之二</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/2021/05/31/Linux/LinuxNote2/" title="Linux实验二笔记">Linux实验二笔记</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">orange @ orange's blog</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/09/01/JavaScript/axios/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>