---
title: H5体验优化的实践与总结
date: 2024-06-15 18:38:52
tags:
sticky: true
categories:
- 工作沉淀
---

# 版权赛事详情页的体验优化

优化时间：**2024.3.20**

## 背景

目前在职主要负责的内容是抖音等宿主的**端内H5/Lynx**（字节内部的高效跨平台框架）页面的编写

其中我负责的一个页面：**赛事详情页**，是抖音游戏（游戏赛事直播间、赛事搜索）赛事的重要信息呈现页面。

**这里补图：直播间场景与搜索场景**

![live_scene](live_scene.jpg)

![search_scene](search_scene.jpg)

![example_shot](example_shot.jpg)

不同的版权赛事厂商会提供接口返回我们指定的数据结构，实现赛事信息的呈现。

以PEL春季赛为例，在2.29-3.3的四天比赛中，日均看播UV超1xx万，而页面的峰值PV也达1xx万

但是页面的首屏性能颇为不佳（尤其是在Android机型下）

## 性能现状

我取了一段比赛进行时（访问高峰期的时间范围）的性能数据作为基准样本，分析ActualFMP、Load事件、秒开绿

> ActualFMP定义：**接口返回时间 - window.performance.timing.navigationStart**。
>
> 这个性能指标接近于LCP，在此页面中接近于真实的用户看到有意义内容的时间。

### 线上统计

| 指标类别                                                     | 统计分位 | 表现                                 | 备注 |
| ------------------------------------------------------------ | -------- | ------------------------------------ | ---- |
| ActualFMP                                                    | 90分位   | iOS：基本低于1s，Android：3.3s～3.5s |      |
| ActualFMP                                                    | 50分位   | iOS：300ms左右，Android： 2s左右     |      |
| Load                                                         | 90分位   | iOS：500ms左右，Android：2.75s       |      |
| Load                                                         | 50分位   | iOS：100ms左右，Android：1.45s       |      |
| 秒开率（取TotalActualFMP≤1s占总量的比值，该时间相比ActualFMP要多上一个容器初始化时间） | -        | iOS：85.48%，Android：22%。整体：60% |      |

### 线下具体分析

以我手上的Android测试机为例，将网络限制至条件下述进行测试：

- 10Mb/s的上传&下载
- 40ms响应时间

| 指标                            | timestamp |
| ------------------------------- | --------- |
| DCL（DOM Content Loaded）       | 1627ms    |
| FCP（First Contentful Paint）   | 1668ms    |
| Load（资源加载完毕）            | 1675.9ms  |
| LCP（Largest Contentful Paint） | 2080ms    |

![分析](perf_analyze.jpg)

### 结论

瓶颈：主js模块的大小过大，加载js资源时间过长。

浏览器在此先是加载html，然后从html中拉资源，并行加载css样式及必要的js模块，这些模块大小共计**895kb**，其中主js模块花了1.06秒进行加载（到1390ms时刻），然后解析又使用了100ms左右。

## 优化思路

现有的端内H5优化手段文章已经非常多了，这里记录一些我调研到总结手段的思路：

- **缓存**：离线包（优化前已使用）
- **前置**：数据预取（prefetch）、资源预加载（html preload）
- **简化**：首屏代码、非首屏模块动态加载
- **拆分**：主js、依赖

### 实践

- 接入prefetch：经验上看能优化100-200ms
- 拆分依赖：Parsed size 降低了120K左右，主js模块拆分了多个chunk，最大的降至300K
- 一些代码的优化

### 优化效果

在线包、离线包体积均降了10%（374K -> 339K）

数据预取下首屏直出效果更强、几乎看不见loading

以下为**三月底统计数据**：

| 场景                           | 图   | 效果                                                         | 备注                                                         |
| ------------------------------ | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 普通搜索入口(ActualFMP 90分位) |      | Android：1.29s => 1.03s (**-20%**)。iOS：838ms => 529ms（**-36.9%**）。整体：1145ms => 879.8ms(**-23.1%**) |                                                              |
| 直播间入口（ActualFMP 90分位） |      | Android：3.02s => 2.28s(-24.5%)。iOS: 864ms => 928ms(+0.07%)，整体：2.7s => 2.064s(**-23.5%**) | 此场景较卡，因为位于进房，许多初始化逻辑，手机性能差的用户时间会表现的非常明显 |

秒开率（整体）：60% => 78.45%**（+30.75%）**，六月初已接近80%

## 更多...

经过日常写代码的注意，其他负责的H5秒开率也基本达到了80%以上